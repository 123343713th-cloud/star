<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ä¹ æµ‹è¯•é¡µé¢</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- å¼•å…¥Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .status { padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 5px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; margin: 10px 0; }
        .course-content { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ“š å­¦å‘˜ç®¡ç†&ä¸šåŠ¡ç»©æ•ˆ&äº§å“è§„åˆ™ - å­¦ä¹ æµ‹è¯•é¡µé¢</h1>

    <div id="status" class="status info">å‡†å¤‡å¼€å§‹å­¦ä¹ ...</div>

    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 15px; margin: 10px 0;">
        <h3>ğŸ”§ æµ‹è¯•è¯¾ç¨‹è¿›åº¦åŒæ­¥ä¿®å¤</h3>
        <button onclick="testProgressSync()" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">æµ‹è¯•è¿›åº¦åŒæ­¥</button>
        <button onclick="checkUserProgress()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">æ£€æŸ¥è¿›åº¦æ•°æ®</button>
        <button onclick="simulateCourseComplete()" style="background: #ffc107; color: black; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">æ¨¡æ‹Ÿè¯¾ç¨‹å®Œæˆ</button>
        <div id="test-log" style="background: #f8f9fa; padding: 10px; border-radius: 5px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 11px; margin: 10px 0; display: none;"></div>
    </div>

    <div class="course-content">
        <h2>è¯¾ç¨‹å†…å®¹ï¼šå­¦å‘˜ç®¡ç†&ä¸šåŠ¡ç»©æ•ˆ&äº§å“è§„åˆ™</h2>
        <p>è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„å­¦ä¹ é¡µé¢ï¼Œç”¨äºæµ‹è¯•å­¦ä¹ æ•°æ®åŒæ­¥åŠŸèƒ½ã€‚</p>
        <p>è¯·åœ¨æ­¤é¡µé¢åœç•™è‡³å°‘30ç§’ï¼Œç„¶åç‚¹å‡»"ç»“æŸå­¦ä¹ "æŒ‰é’®ã€‚</p>
        <div id="timer">å­¦ä¹ æ—¶é•¿: 0ç§’</div>
    </div>

    <button onclick="startLearning()">å¼€å§‹å­¦ä¹ </button>
    <button onclick="endLearning()">ç»“æŸå­¦ä¹ </button>
    <button onclick="checkSyncStatus()">æ£€æŸ¥åŒæ­¥çŠ¶æ€</button>
    <button onclick="window.location.href='index.html'">è¿”å›é¦–é¡µ</button>

    <h3>ğŸ“ å­¦ä¹ æ—¥å¿—:</h3>
    <div id="log" class="log">ç­‰å¾…å­¦ä¹ å¼€å§‹...</div>

    <script src="js/supabase-client.js"></script>
    <script src="js/learning-tracker.js"></script>

    <script>
        let startTime = null;
        let learningTimer = null;
        let currentUser = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logDiv.innerHTML += `${timestamp} ${prefix} ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        function startLearning() {
            log('å¼€å§‹å­¦ä¹ è¯¾ç¨‹ï¼šå­¦å‘˜ç®¡ç†&ä¸šåŠ¡ç»©æ•ˆ&äº§å“è§„åˆ™', 'info');
            updateStatus('æ­£åœ¨å­¦ä¹ ä¸­...', 'info');
            startTime = Date.now();

            // å¯åŠ¨è®¡æ—¶å™¨
            learningTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = `å­¦ä¹ æ—¶é•¿: ${elapsed}ç§’`;
            }, 1000);

            // æ‰‹åŠ¨è§¦å‘å­¦ä¹ è®°å½•
            if (window.learningTracker) {
                window.learningTracker.startLearning('course2', 'å­¦å‘˜ç®¡ç†&ä¸šåŠ¡ç»©æ•ˆ&äº§å“è§„åˆ™');
                log('å­¦ä¹ è¿½è¸ªå™¨å·²å¯åŠ¨', 'success');
            } else {
                log('å­¦ä¹ è¿½è¸ªå™¨æœªåŠ è½½ï¼Œä½¿ç”¨æ‰‹åŠ¨è®°å½•', 'warning');
            }
        }

        async function endLearning() {
            if (!startTime) {
                log('è¯·å…ˆå¼€å§‹å­¦ä¹ ', 'error');
                return;
            }

            clearInterval(learningTimer);
            const duration = Date.now() - startTime;
            const durationSeconds = Math.floor(duration / 1000);

            log(`ç»“æŸå­¦ä¹ ï¼Œæ€»æ—¶é•¿: ${durationSeconds}ç§’`, 'info');
            updateStatus('æ­£åœ¨ä¿å­˜å­¦ä¹ æ•°æ®...', 'info');

            try {
                // æ‰‹åŠ¨ä¿å­˜å­¦ä¹ ä¼šè¯
                await saveLearningSession(durationSeconds);
                log('å­¦ä¹ ä¼šè¯ä¿å­˜æˆåŠŸ', 'success');

                // æ‰‹åŠ¨ä¿å­˜å­¦ä¹ è¿›åº¦
                await saveLearningProgress();
                log('å­¦ä¹ è¿›åº¦ä¿å­˜æˆåŠŸ', 'success');

                updateStatus('å­¦ä¹ æ•°æ®ä¿å­˜å®Œæˆï¼', 'success');

            } catch (error) {
                log(`ä¿å­˜å­¦ä¹ æ•°æ®å¤±è´¥: ${error.message}`, 'error');
                updateStatus(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function saveLearningSession(durationSeconds) {
            // ç­‰å¾…ç”¨æˆ·è®¤è¯
            const { data: { session } } = await window.supabase.auth.getSession();
            if (!session) {
                throw new Error('ç”¨æˆ·æœªç™»å½•');
            }

            const sessionData = {
                user_id: session.user.id,
                course_id: 'course2',
                page_type: 'course',
                start_time: new Date(startTime).toISOString(),
                end_time: new Date().toISOString(),
                duration: durationSeconds,
                is_completed: durationSeconds >= 30,
                created_at: new Date().toISOString()
            };

            log(`å‡†å¤‡ä¿å­˜å­¦ä¹ ä¼šè¯æ•°æ®: ${JSON.stringify(sessionData)}`, 'info');

            const { data, error } = await window.supabase
                .from('learning_sessions')
                .insert(sessionData)
                .select();  // æ·»åŠ  .select() æ¥è¿”å›æ’å…¥çš„æ•°æ®

            if (error) {
                log(`æ•°æ®åº“æ’å…¥é”™è¯¯: ${error.message}`, 'error');
                throw error;
            }

            log(`å­¦ä¹ ä¼šè¯å·²åŒæ­¥åˆ°äº‘ç«¯ï¼Œè¿”å›æ•°æ®: ${JSON.stringify(data)}`, 'success');
            return data;
        }

        async function saveLearningProgress() {
            // ç­‰å¾…ç”¨æˆ·è®¤è¯
            const { data: { session } } = await window.supabase.auth.getSession();
            if (!session) {
                throw new Error('ç”¨æˆ·æœªç™»å½•');
            }

            const progressData = {
                user_id: session.user.id,
                course_id: 'course2',
                lessons_completed: 1,
                total_lessons: 10,
                progress_percentage: 10,
                total_study_time: Math.floor((Date.now() - startTime) / 1000),
                session_count: 1,
                last_access_time: new Date().toISOString()
            };

            log(`å‡†å¤‡ä¿å­˜å­¦ä¹ è¿›åº¦æ•°æ®: ${JSON.stringify(progressData)}`, 'info');

            const { data, error } = await window.supabase
                .from('user_progress')
                .upsert(progressData, {
                    onConflict: 'user_id,course_id'
                })
                .select();  // æ·»åŠ  .select() æ¥è¿”å›æ’å…¥çš„æ•°æ®

            if (error) {
                log(`è¿›åº¦æ’å…¥é”™è¯¯: ${error.message}`, 'error');
                throw error;
            }

            log(`å­¦ä¹ è¿›åº¦å·²åŒæ­¥åˆ°äº‘ç«¯ï¼Œè¿”å›æ•°æ®: ${JSON.stringify(data)}`, 'success');
            return data;
        }

        async function checkSyncStatus() {
            log('æ£€æŸ¥äº‘ç«¯åŒæ­¥çŠ¶æ€...', 'info');

            try {
                const { data: { session } } = await window.supabase.auth.getSession();
                if (!session) {
                    log('ç”¨æˆ·æœªç™»å½•', 'error');
                    return;
                }

                // æ£€æŸ¥å­¦ä¹ ä¼šè¯
                const { data: sessions, error: sessionError } = await window.supabase
                    .from('learning_sessions')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .eq('course_id', 'course2')
                    .order('created_at', { ascending: false })
                    .limit(5);

                // æ£€æŸ¥å­¦ä¹ è¿›åº¦
                const { data: progress, error: progressError } = await window.supabase
                    .from('user_progress')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .eq('course_id', 'course2')
                    .single();

                if (sessionError || progressError) {
                    log(`æŸ¥è¯¢æ•°æ®å¤±è´¥: ${sessionError?.message || progressError?.message}`, 'error');
                    return;
                }

                log(`äº‘ç«¯æ•°æ®æŸ¥è¯¢æˆåŠŸ:`, 'success');
                log(`- å­¦ä¹ ä¼šè¯æ•°é‡: ${sessions.length}`, 'info');
                if (progress) {
                    log(`- å­¦ä¹ è¿›åº¦: ${progress.progress_percentage}%`, 'info');
                    log(`- æ€»å­¦ä¹ æ—¶é—´: ${progress.total_study_time}ç§’`, 'info');
                }

            } catch (error) {
                log(`æ£€æŸ¥åŒæ­¥çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•è¯¾ç¨‹è¿›åº¦åŒæ­¥ä¿®å¤
        function testLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('test-log');
            if (logDiv) {
                logDiv.style.display = 'block';
                const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
                logDiv.innerHTML += `${timestamp} ${prefix} ${message}<br>`;
                logDiv.scrollTop = logDiv.scrollHeight;
            }
            console.log(`[TEST-${timestamp}] ${message}`);
        }

        // æµ‹è¯•è¯¾ç¨‹è¿›åº¦åŒæ­¥
        async function testProgressSync() {
            testLog('å¼€å§‹æµ‹è¯•è¯¾ç¨‹è¿›åº¦åŒæ­¥ä¿®å¤...', 'info');

            try {
                // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
                const { data: { session } } = await window.supabase.auth.getSession();
                if (!session) {
                    testLog('ç”¨æˆ·æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•', 'error');
                    return;
                }

                testLog(`ç”¨æˆ·å·²ç™»å½•: ${session.user.email}`, 'success');

                // åˆ›å»ºæ¨¡æ‹Ÿè¿›åº¦æ•°æ®
                const mockProgress = {
                    courseId: 'course2',
                    totalLessons: 10,
                    lessonsCompleted: 3,
                    totalStudyTime: 25 * 60 * 1000, // 25åˆ†é’Ÿ
                    sessionCount: 2,
                    lastAccessTime: Date.now()
                };
                mockProgress.progressPercentage = Math.round((mockProgress.lessonsCompleted / mockProgress.totalLessons) * 100);

                testLog(`æ¨¡æ‹Ÿè¿›åº¦æ•°æ®: ${JSON.stringify(mockProgress)}`, 'info');

                // æ‰‹åŠ¨è°ƒç”¨ä¿®å¤åçš„syncProgressToCloud
                if (window.learningTracker) {
                    await window.learningTracker.syncProgressToCloud(mockProgress.courseId, mockProgress);
                    testLog('è¯¾ç¨‹è¿›åº¦åŒæ­¥æµ‹è¯•å®Œæˆ', 'success');
                } else {
                    testLog('learningTrackeræœªåˆå§‹åŒ–', 'error');
                }

            } catch (error) {
                testLog(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥ç”¨æˆ·è¿›åº¦æ•°æ®
        async function checkUserProgress() {
            testLog('æ£€æŸ¥äº‘ç«¯ç”¨æˆ·è¿›åº¦æ•°æ®...', 'info');

            try {
                const { data: { session } } = await window.supabase.auth.getSession();
                if (!session) {
                    testLog('ç”¨æˆ·æœªç™»å½•', 'error');
                    return;
                }

                // æ£€æŸ¥å­¦ä¹ è¿›åº¦
                const { data: progress, error: progressError } = await window.supabase
                    .from('user_progress')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .order('updated_at', { ascending: false });

                if (progressError) {
                    testLog(`æŸ¥è¯¢è¿›åº¦æ•°æ®å¤±è´¥: ${progressError.message}`, 'error');
                    return;
                }

                testLog(`äº‘ç«¯è¿›åº¦æ•°æ®æŸ¥è¯¢æˆåŠŸ:`, 'success');
                testLog(`- å­¦ä¹ è¿›åº¦è®°å½•æ•°é‡: ${progress.length}`, 'info');

                progress.forEach(p => {
                    testLog(`  è¯¾ç¨‹ ${p.course_id}: ${p.progress_percentage}% (${p.lessons_completed}/${p.total_lessons}), å­¦ä¹ æ—¶é—´: ${p.total_study_time}ç§’`, 'info');
                });

                // åŒæ—¶æ£€æŸ¥å­¦ä¹ ä¼šè¯
                const { data: sessions, error: sessionError } = await window.supabase
                    .from('learning_sessions')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (sessionError) {
                    testLog(`æŸ¥è¯¢ä¼šè¯æ•°æ®å¤±è´¥: ${sessionError.message}`, 'error');
                } else {
                    testLog(`- å­¦ä¹ ä¼šè¯è®°å½•æ•°é‡: ${sessions.length}`, 'info');
                }

            } catch (error) {
                testLog(`æ£€æŸ¥æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¨¡æ‹Ÿè¯¾ç¨‹å®Œæˆ
        async function simulateCourseComplete() {
            testLog('æ¨¡æ‹Ÿè¯¾ç¨‹2å®Œæˆ...', 'info');

            try {
                const { data: { session } } = await window.supabase.auth.getSession();
                if (!session) {
                    testLog('ç”¨æˆ·æœªç™»å½•', 'error');
                    return;
                }

                const completeProgress = {
                    courseId: 'course2',
                    totalLessons: 10,
                    lessonsCompleted: 10,
                    totalStudyTime: 300 * 60 * 1000, // 5å°æ—¶
                    sessionCount: 10,
                    lastAccessTime: Date.now()
                };
                completeProgress.progressPercentage = 100;

                testLog(`å®Œæˆè¿›åº¦æ•°æ®: ${JSON.stringify(completeProgress)}`, 'info');

                if (window.learningTracker) {
                    await window.learningTracker.syncProgressToCloud(completeProgress.courseId, completeProgress);
                    testLog('è¯¾ç¨‹2è¿›åº¦è®¾ç½®ä¸º100%å®Œæˆ', 'success');
                }

            } catch (error) {
                testLog(`æ¨¡æ‹Ÿå®Œæˆå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        document.addEventListener('DOMContentLoaded', async function() {
            log('å­¦ä¹ æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'info');

            try {
                // ç­‰å¾…Supabaseåˆå§‹åŒ–
                await new Promise((resolve) => {
                    const checkInterval = setInterval(() => {
                        if (window.supabaseClientInitialized) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                });

                // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
                const { data: { session } } = await window.supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    log(`ç”¨æˆ·å·²ç™»å½•: ${session.user.email}`, 'success');
                    updateStatus(`æ¬¢è¿å›æ¥ï¼Œ${session.user.email}ï¼`, 'success');
                } else {
                    log('ç”¨æˆ·æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•', 'warning');
                    updateStatus('ç”¨æˆ·æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•', 'error');
                }
            } catch (error) {
                log(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                updateStatus(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>